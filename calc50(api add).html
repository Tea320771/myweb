<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소송비용액 확정 신청 도우미 (로컴 AI)</title>
    <style>
        :root {
            --color-lawyer: #2563eb;
            --color-scrivener: #059669;
            --color-court: #7c3aed;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --border-color: #e5e7eb;
            --ai-highlight: #fffbeb; 
            --ai-border: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            overflow-x: hidden;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            opacity: 0; 
            transition: opacity 1s ease;
        }

        /* --- 공통 유틸리티 --- */
        .hidden { display: none !important; }
        .fade-in-section { animation: fadeInUp 0.6s ease-out forwards; }
        .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- AI Smart Upload Styles --- */
        .smart-upload-area {
            border: 2px dashed var(--color-lawyer);
            background-color: #eff6ff;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .smart-upload-area:hover, .smart-upload-area.drag-over {
            background-color: #dbeafe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            border-color: #1d4ed8;
        }
        .upload-icon { font-size: 48px; margin-bottom: 15px; display: block; }
        .upload-title { font-weight: 800; font-size: 1.2rem; color: var(--color-lawyer); margin-bottom: 8px; }
        .upload-desc { font-size: 0.95rem; color: #4b5563; line-height: 1.6; }

        /* 로딩 오버레이 */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-lawyer);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AI 필드 강조 */
        @keyframes aiPulse {
            0% { background-color: var(--ai-highlight); border-color: var(--ai-border); box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
            100% { background-color: #fff; border-color: #e5e7eb; box-shadow: none; }
        }
        .ai-filled { animation: aiPulse 2.5s ease-out forwards; }

        /* --- 인트로 메시지 --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .intro-message {
            font-size: 1.5rem; font-weight: 700; color: var(--color-lawyer);
            text-align: center; line-height: 1.6;
            animation: textFlow 2.5s ease-in-out forwards;
            padding: 20px;
        }
        @keyframes textFlow {
            0% { opacity: 0; transform: translateY(30px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(30px); }
        }

        #transition-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .transition-content {
            font-size: 1.5rem; font-weight: 700; color: var(--color-lawyer);
            text-align: center; line-height: 1.6;
            opacity: 0; padding: 20px;
        }
        .animate-flow { animation: middleFlow 2.5s ease-in-out forwards; }
        @keyframes middleFlow {
            0% { opacity: 0; transform: translateY(30px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(30px); }
        }

        /* --- 카드 및 폼 스타일 --- */
        .intro-card {
            background: white; max-width: 650px; margin: 40px auto; padding: 40px;
            border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;
        }
        .intro-title { font-size: 1.8rem; font-weight: 800; text-align: center; color: var(--color-lawyer); margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.95rem; font-weight: 700; margin-bottom: 8px; color: #374151; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: var(--color-lawyer); }
        .form-input[readonly] { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        
        .btn-start {
            width: 100%; padding: 16px; background-color: var(--color-lawyer); color: white; border: none; border-radius: 8px;
            font-size: 1.2rem; font-weight: 700; cursor: pointer; margin-top: 20px; transition: background-color 0.3s;
        }
        .btn-start:hover { background-color: #1d4ed8; }
        .btn-start:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* 수동 작성 버튼 스타일 (NEW) */
        .btn-manual-trigger {
            background: none; border: 2px solid #9ca3af; color: #6b7280;
            padding: 12px 24px; border-radius: 99px; font-weight: 600; cursor: pointer;
            transition: all 0.3s; font-size: 0.95rem; margin-top: 10px;
        }
        .btn-manual-trigger:hover {
            border-color: var(--color-lawyer); color: var(--color-lawyer); background-color: #eff6ff;
        }
        
        .section-header { border-bottom: 2px solid #eee; margin: 30px 0 20px 0; padding-bottom: 10px; font-weight:bold; color:#4b5563; }
        .no-rep-check { margin-top: -10px; margin-bottom: 20px; display: flex; align-items: center; font-size: 0.9rem; color: #6b7280; cursor: pointer; }
        .no-rep-check input { margin-right: 8px; accent-color: var(--color-lawyer); }
        .confirm-check { margin-top: 10px; display: flex; align-items: center; font-size: 0.95rem; color: #b91c1c; font-weight: 600; cursor: pointer; }
        .confirm-check input { margin-right: 8px; accent-color: #b91c1c; width: 16px; height: 16px; }

        /* --- 계산기 및 결과 스타일 생략 (기존 유지) --- */
        h1 { text-align: center; color: #111827; margin-bottom: 2rem; font-weight: 800; }
        .top-row-container { display: flex; gap: 20px; margin-bottom: 25px; align-items: stretch; flex-wrap: wrap; }
        .summary-box { flex: 1; background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; gap: 8px; font-size: 0.95rem; line-height: 1.5; min-width: 280px; }
        .case-info-summary { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #93c5fd; font-size: 0.9rem; color: #1e3a8a; }
        .case-item { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .case-item span:first-child { font-weight: 600; color: #1d4ed8; margin-right: 10px; }
        .settings-box { flex: 2; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #d1d5db; display: flex; gap: 20px; align-items: start; flex-wrap: wrap; min-width: 280px; }
        .setting-group { flex: 1; min-width: 180px; width: 100%; }
        .setting-group label { display: block; font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; color: #4b5563; }
        .setting-group select, .setting-group input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .grid-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); display: flex; flex-direction: column; transition: all 0.3s ease; }
        .card-hidden { display: none !important; }
        .card-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--bg-color); color: #111827; display: flex; justify-content: space-between; align-items: center; }
        .badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 99px; font-weight: 600; background-color: #f3f4f6; color: #4b5563; }
        .fee-inputs-wrapper { background-color: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 15px; }
        .soga-inputs-wrapper { margin-top: 10px; display: block !important; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1.1rem; text-align: right; box-sizing: border-box; font-family: inherit; }
        .input-group input:focus { outline: none; border-color: var(--color-lawyer); }
        .helper-text { font-size: 0.8rem; color: #6b7280; text-align: right; margin-top: 4px; min-height: 1.2em; }
        .options-container { background-color: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f3f4f6; display: flex; flex-direction: column; gap: 8px; }
        .check-item { display: flex; align-items: center; cursor: pointer; }
        .check-item input { margin-right: 8px; width: 16px; height: 16px; cursor: pointer; accent-color: currentColor; }
        .check-item span { font-size: 0.9rem; font-weight: 500; }
        .opt-withdraw { color: #be123c; }
        .opt-scrivener { color: var(--color-scrivener); }
        .opt-court { color: var(--color-court); }
        .opt-paper { color: #854d0e; font-weight:600; border-top: 1px solid #eee; padding-top: 8px; margin-top: 4px; }
        .result-section { border-top: 2px dashed #e5e7eb; padding-top: 15px; }
        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 0.95rem; cursor: help; }
        .result-row:hover { background-color: #f3f4f6; border-radius: 4px; padding-left: 5px; padding-right: 5px; }
        .lbl { font-weight: 600; color: #4b5563; }
        .val { font-weight: 700; font-size: 1.1rem; transition: opacity 0.3s; }
        .val.inactive { opacity: 0.3; text-decoration: line-through; }
        .val.lawyer { color: var(--color-lawyer); }
        .val.scrivener { color: var(--color-scrivener); }
        .val.court { color: var(--color-court); }
        .total-section { background: #fff; border: 2px solid var(--text-main); border-radius: 12px; padding: 30px; text-align: center; margin-top: 20px; }
        .total-label { font-size: 1.2rem; font-weight: 700; color: #374151; margin-bottom: 10px; }
        .total-amount { font-size: 2.5rem; font-weight: 900; color: var(--text-main); margin-bottom: 20px; }
        .breakdown { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; font-size: 0.95rem; }
        .bd-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        /* --- 소명자료 및 미리보기 스타일 --- */
        .evidence-group { margin-bottom: 25px; }
        .evidence-group-title { font-size: 1.1rem; font-weight: 700; color: #374151; margin-bottom: 10px; border-left: 4px solid var(--color-lawyer); padding-left: 10px; }
        .evidence-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
        .evidence-item { background: #fff; border: 1px solid #e5e7eb; padding: 12px; border-radius: 8px; display: flex; align-items: center; cursor: pointer; transition: background 0.2s; }
        .evidence-item:hover { background: #f9fafb; border-color: #d1d5db; }
        .evidence-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--color-lawyer); cursor: pointer; }
        .evidence-item span { font-size: 0.95rem; color: #4b5563; }
        .doc-preview { background: white; width: 100%; max-width: 210mm; min-height: 297mm; margin: 0 auto; padding: 25mm 20mm; box-shadow: 0 0 15px rgba(0,0,0,0.1); box-sizing: border-box; color: #000; font-family: "Batang", "KoPub Batang", serif; line-height: 1.6; position: relative; }
        .doc-header-title { font-size: 20pt; font-weight: bold; text-align: center; margin-bottom: 40px; margin-top: 50px; letter-spacing: 5px; }
        .party-box { margin-bottom: 20px; }
        .party-label { font-size: 12pt; font-weight: bold; margin-bottom: 4px; }
        .party-content { font-size: 11pt; margin-left: 10px; margin-bottom: 4px; }
        .agent-content { font-size: 11pt; margin-left: 30px; margin-top:4px; margin-bottom: 4px; }
        .doc-section-title { font-size: 13pt; font-weight: bold; text-align: center; margin-top: 40px; margin-bottom: 15px; }
        .doc-text { font-size: 12pt; text-align: justify; line-height: 1.8; margin-bottom: 10px; padding-left: 10px; padding-right: 10px; word-break: keep-all; }
        .doc-list { font-size: 11pt; margin-left: 20px; margin-bottom: 10px; line-height: 1.8; }
        .doc-footer-date { margin-top: 60px; text-align: center; font-size: 12pt; }
        .doc-footer-court { margin-top: 30px; text-align: center; font-size: 14pt; font-weight: bold; }
        .doc-signature { margin-top: 30px; text-align: right; margin-right: 20px; font-size: 12pt; }
        .calc-header { font-size: 18pt; font-weight: bold; text-align: center; margin-bottom: 20px; margin-top: 30px; }
        .calc-info-line { font-size: 11pt; margin-bottom: 8px; }
        .calc-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10pt; table-layout: fixed; }
        .calc-table th, .calc-table td { border: 1px solid #000; padding: 6px 4px; vertical-align: middle; word-break: keep-all; }
        .calc-table th { background-color: #f8f8f8; font-weight: bold; text-align: center; height: 35px; }
        .calc-table td.center { text-align: center; }
        .calc-table td.right { text-align: right; padding-right: 8px; }
        .calc-table td.left { text-align: left; padding-left: 8px; }
        .calc-table td.remarks { font-size: 9pt; white-space: pre-wrap; line-height: 1.3; color: #333; }
        
        @media print {
            body { background: none; margin: 0; padding: 0; }
            .container > :not(#previewPage) { display: none; }
            #previewPage { display: block !important; margin: 0; padding: 0; }
            .doc-preview { box-shadow: none; margin: 0; width: 100%; max-width: 100%; height: auto; min-height: 0; border:none; }
            .preview-actions { display: none; }
            .page-break { page-break-before: always; }
        }
        .preview-actions { text-align: center; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; }

        /* 뒤로가기 버튼 */
        .btn-back-floating {
            position: fixed; left: 30px; top: 50%; transform: translateY(-50%); width: 56px; height: 56px; border-radius: 50%;
            background-color: white; border: 2px solid var(--color-lawyer); color: var(--color-lawyer); box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 11000; transition: all 0.3s ease; opacity: 0; pointer-events: none; visibility: hidden;
        }
        .btn-back-floating.visible { opacity: 1; pointer-events: auto; visibility: visible; }
        .btn-back-floating:hover { background-color: var(--color-lawyer); color: white; transform: translateY(-50%) scale(1.1); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3); }
        @media (max-width: 768px) { .btn-back-floating { left: 10px; width: 45px; height: 45px; } }

        /* 자동완성 */
        .autocomplete-wrapper { position: relative; width: 100%; }
        .suggestion-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-height: 200px; overflow-y: auto; z-index: 1000; list-style: none; padding: 0; margin: 0; display: none; }
        .suggestion-item { padding: 10px 12px; cursor: pointer; font-size: 0.95rem; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f3f4f6; color: var(--color-lawyer); font-weight: 600; }
        .input-with-list { border-bottom-left-radius: 0 !important; border-bottom-right-radius: 0 !important; }
    </style>
</head>
<body>

<div id="intro-overlay">
    <div class="intro-message">
        소송비용확정신청서를 작성하기 전, 관련 문서를 올려주시면<br>
        로컴 AI가 문서를 자동 분석하여 소송비용확정신청서를 자동 작성해드려요.
    </div>
</div>

<div id="transition-overlay" class="hidden">
    <div id="transition-text-content" class="transition-content"></div>
</div>

<div id="globalBackBtn" class="btn-back-floating" onclick="goBackStep()" title="이전 단계로">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
</div>

<div class="container" id="mainContainer">

    <div id="introPage" class="page-section">
        <div class="intro-card">
            <div class="intro-title">소송비용액 확정 신청<br>AI 스마트 작성</div>
            
            <div class="smart-upload-area" id="smartUploadZone" onclick="document.getElementById('docInput').click()">
                <input type="file" id="docInput" multiple style="display:none" onchange="handleFiles(this.files)">
                
                <div id="upload-content">
                    <span class="upload-icon">🤖</span>
                    <div class="upload-title">AI 스마트 문서 분석</div>
                    <div class="upload-desc">
                        판결문, 사건위임계약서, 영수증, 이체내역확인서 등 서류를<br>
                        여기에 업로드(혹은 클릭)하면 자동으로 내용을 채워드려요.
                    </div>
                </div>
                
                <div id="upload-loader" class="loader-overlay hidden">
                    <div class="spinner"></div>
                    <div style="font-weight:bold; color:var(--color-lawyer)">문서 분석 및 데이터 추출 중...</div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn-manual-trigger" onclick="showManualInput()">
                    수동으로 작성을 원하세요? 수동 작성하기
                </button>
            </div>
            
            <div id="manualInputSection" class="hidden">
                <div id="step1-area">
                    <div class="section-header">1. 신청인(채권자) 정보</div>
                    <div class="form-group">
                        <label class="form-label">신청인 이름 <span style="color:red">*</span></label>
                        <input type="text" id="applicantName" class="form-input" placeholder="이름을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label class="form-label">신청인 주소 <span style="color:red">*</span></label>
                        <input type="text" id="applicantAddr" class="form-input" placeholder="주소를 입력하세요">
                    </div>
                </div>

                <div id="step2-area" class="hidden">
                    <div class="section-header">2. 신청인 소송대리인 정보</div>
                    <label class="no-rep-check">
                        <input type="checkbox" id="noRepresentative" onchange="toggleRepInputs(this)">
                        <span>대리인 없음 (직접 소송)</span>
                    </label>
                    <div id="rep-inputs">
                        <div class="form-group">
                            <label class="form-label">대리인(법무법인) 이름</label>
                            <input type="text" id="repName" class="form-input" placeholder="예: 법무법인 조율">
                        </div>
                        <div class="form-group">
                            <label class="form-label">담당 변호사 (선택)</label>
                            <input type="text" id="repLawyerName" class="form-input" placeholder="예: 홍길동, 김철수">
                        </div>
                        <div class="form-group">
                            <label class="form-label">대리인 사무실 주소</label>
                            <input type="text" id="repAddr" class="form-input" placeholder="주소를 입력하세요">
                        </div>
                    </div>
                </div>

                <div id="step3-area" class="hidden">
                    <div class="section-header">3. 피신청인(채무자) 정보</div>
                    <div class="form-group">
                        <label class="form-label">피신청인 이름 <span style="color:red">*</span></label>
                        <input type="text" id="respondentName" class="form-input" placeholder="이름을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label class="form-label">피신청인 주소 <span style="color:red">*</span></label>
                        <input type="text" id="respondentAddr" class="form-input" placeholder="주소를 입력하세요">
                    </div>
                    <button id="btnToCaseInfo" class="btn-start hidden" onclick="goToCaseInfo()">다음 단계로 (사건 정보)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="caseInfoPage" class="page-section hidden">
        <div class="intro-card">
            <div class="intro-title">사건 정보 입력</div>
            <div style="text-align:center; color:#6b7280; margin-bottom:30px;">
                판결문(결정문)을 보고 정확히 입력해주세요.
            </div>

            <div id="case-step-1">
                <div class="section-header">1심(제1심) 사건 정보</div>
                <div class="form-group">
                    <label class="form-label">1심 법원명</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="courtName1" class="form-input" placeholder="예: 서울중앙지방법원" onkeyup="checkCaseInfoStep()" autocomplete="off">
                        <ul id="suggestionList1" class="suggestion-list"></ul>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">1심 사건번호</label>
                    <input type="text" id="caseNo1" class="form-input" placeholder="예: 2023가합12345" onkeyup="checkCaseInfoStep()">
                </div>
                <div class="form-group">
                    <label class="form-label">1심 선고일(또는 결정일)</label>
                    <input type="text" id="date1" class="form-input" placeholder="예: 2024. 6. 12.">
                </div>
                <label class="confirm-check">
                    <input type="checkbox" id="finalized1" onchange="checkCaseInfoStep()">
                    <span>1심 사건 확정 (체크 시 2심 입력란이 뜨지 않습니다)</span>
                </label>
            </div>

            <div id="case-step-2" class="hidden" style="margin-top:30px;">
                <div class="section-header">2심(항소/항고심) 사건 정보</div>
                <div class="form-group">
                    <label class="form-label">2심 법원명</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="courtName2" class="form-input" placeholder="예: 서울고등법원" onkeyup="checkCaseInfoStep()" autocomplete="off">
                        <ul id="suggestionList2" class="suggestion-list"></ul>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">2심 사건번호</label>
                    <input type="text" id="caseNo2" class="form-input" placeholder="예: 2024나12345" onkeyup="checkCaseInfoStep()">
                </div>
                <div class="form-group">
                    <label class="form-label">2심 선고일</label>
                    <input type="text" id="date2" class="form-input" placeholder="예: 2025. 7. 25.">
                </div>
                <label class="confirm-check">
                    <input type="checkbox" id="finalized2" onchange="checkCaseInfoStep()">
                    <span>2심 사건 확정 (체크 시 3심 입력란이 뜨지 않습니다)</span>
                </label>
            </div>

            <div id="case-step-3" class="hidden" style="margin-top:30px;">
                <div class="section-header">3심(상고/재항고심) 사건 정보</div>
                <div class="form-group">
                    <label class="form-label">3심 법원명</label>
                    <input type="text" id="courtName3" class="form-input" value="대법원" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">3심 사건번호</label>
                    <input type="text" id="caseNo3" class="form-input" placeholder="예: 2025다12345" onkeyup="checkCaseInfoStep()">
                </div>
                 <div class="form-group">
                    <label class="form-label">3심 선고일</label>
                    <input type="text" id="date3" class="form-input" placeholder="예: 2025. 11. 6.">
                </div>
            </div>
            
            <div class="form-group" style="margin-top:20px;">
                <label class="form-label">최종 판결 확정일</label>
                <input type="text" id="finalDate" class="form-input" placeholder="예: 2025. 11. 6.">
            </div>

            <button id="btnToCalculator" class="btn-start hidden" onclick="goToCalculator()">소송비용 통합 계산기 이동</button>
        </div>
    </div>

    <div id="calcPage" class="page-section hidden">
        <h1>소송비용 통합 계산기</h1>
        <div class="top-row-container">
            <div class="summary-box">
                <div><strong>신청인:</strong> <span id="dispAppName">-</span><br> (대리인: <span id="dispRepName">-</span>)</div>
                <div><strong>피신청인:</strong> <span id="dispRespName">-</span></div>
                <div id="caseSummary" class="case-info-summary"></div>
            </div>
            <div class="settings-box">
                <div class="setting-group" style="width:100%; min-width: 250px;">
                    <label for="caseType">사건 종류 <span style="color:red">*</span></label>
                    <select id="caseType" onchange="showContentAndCalculate()">
                        <option value="" selected disabled>사건 종류를 선택하세요</option>
                        <option value="civil">민사 (일반)</option>
                        <option value="civil_app">민사 신청 (가압류/가처분 등)</option>
                        <option value="family">가사 소송</option>
                        <option value="admin">행정</option>
                        <option value="patent">특허</option>
                    </select>
                </div>
                <div id="family-specific-container" class="hidden setting-group" style="width:100%; min-width: 250px; border-left: 3px solid var(--color-lawyer); padding-left: 10px;">
                    <label for="familySpecificCase">가사 사건명 <span style="color:red">*</span></label>
                    <select id="familySpecificCase" onchange="handleFamilyCaseChange()">
                        <option value="" selected disabled>상세 사건을 선택하세요</option>
                    </select>
                    <div id="family-category-display" style="font-size: 0.85rem; color: var(--color-lawyer); margin-top: 5px; font-weight: bold;"></div>
                </div>
                <div class="setting-group" style="width:100%; min-width: 250px;">
                    <label for="partyCount">전체 당사자 수 (원고+피고)</label>
                    <input type="number" id="partyCount" value="2" min="2" onchange="calculateAll()" onkeyup="calculateAll()">
                </div>
            </div>
        </div>

        <div id="main-calc-content" class="hidden">
            <div class="grid-wrapper">
                <div class="card" id="card-1">
                    <div class="card-header">1심 (제1심) <span class="badge">지방법원</span></div>
                    <div class="fee-inputs-wrapper">
                        <div class="input-group">
                            <label style="color:#15803d">지출한 변호사 착수금</label>
                            <input type="text" id="startFee1" placeholder="금액 입력" onkeyup="formatCurrency(this, 1);">
                        </div>
                        <div class="input-group" style="margin-bottom:0">
                            <label style="color:#15803d">지출한 변호사 성공보수</label>
                            <input type="text" id="successFee1" placeholder="금액 입력" onkeyup="formatCurrency(this, 1);">
                        </div>
                    </div>
                    <div id="soga-container-1" class="soga-inputs-wrapper">
                        <div class="input-group">
                            <label>소송목적의 값 (소가)</label>
                            <input type="text" id="soga1" placeholder="금액 입력" onkeyup="formatCurrency(this, 1);">
                            <div class="helper-text" id="korean1">0원</div>
                        </div>
                        <div class="options-container">
                            <label class="check-item opt-court"><input type="checkbox" id="isPlaintiff1" onchange="calculateAll()" checked><span>원고일 경우 체크</span></label>
                            <label class="check-item opt-withdraw hidden" id="opt-before-1" style="color:#b91c1c"><input type="checkbox" id="beforeInterrogation1" onchange="calculateAll()"><span>심문기일 전 신청취하</span></label>
                            <label class="check-item opt-withdraw"><input type="checkbox" id="withdraw1" onchange="calculateAll()"><span>심문기일 중/후 신청 취하</span></label>
                            <label class="check-item opt-scrivener"><input type="checkbox" id="useScrivener1" onchange="calculateAll()"><span>서기료 포함</span></label>
                            <label class="check-item opt-paper"><input type="checkbox" id="isPaper1" onchange="calculateAll()"><span>종이소송</span></label>
                        </div>
                        <div class="result-section">
                            <div class="result-row" id="row-lawyer-1"><span class="lbl">변호사 보수</span><span class="val lawyer" id="lawyer1">0</span></div>
                            <div class="result-row" id="row-scrivener-1"><span class="lbl">서기료</span><span class="val scrivener inactive" id="scrivener1">0</span></div>
                            <div class="result-row" id="row-stamp-1"><span class="lbl">인지대</span><span class="val court" id="stamp1">0</span></div>
                            <div class="result-row" id="row-service-1"><span class="lbl">송달료</span><span class="val court" id="service1">0</span></div>
                        </div>
                    </div>
                </div>

                <div class="card card-hidden" id="card-2">
                    <div class="card-header"><span id="txt-inst-2">2심 (항소심)</span> <span class="badge">고등/합의부</span></div>
                    <div class="fee-inputs-wrapper">
                        <div class="input-group">
                            <label style="color:#15803d">지출한 변호사 착수금</label>
                            <input type="text" id="startFee2" placeholder="금액 입력" onkeyup="formatCurrency(this, 2);">
                        </div>
                        <div class="input-group" style="margin-bottom:0">
                            <label style="color:#15803d">지출한 변호사 성공보수</label>
                            <input type="text" id="successFee2" placeholder="금액 입력" onkeyup="formatCurrency(this, 2);">
                        </div>
                    </div>
                    <div id="soga-container-2" class="soga-inputs-wrapper">
                        <div class="input-group">
                            <label>불복범위 (소가)</label>
                            <input type="text" id="soga2" placeholder="금액 입력" onkeyup="formatCurrency(this, 2);">
                            <div class="helper-text" id="korean2">0원</div>
                        </div>
                        <div class="options-container">
                            <label class="check-item opt-court"><input type="checkbox" id="isAppellant2" onchange="calculateAll()"><span>항소인일 경우 체크</span></label>
                            <label class="check-item opt-withdraw hidden" id="opt-before-2" style="color:#b91c1c"><input type="checkbox" id="beforeInterrogation2" onchange="calculateAll()"><span>심문기일 전 취하</span></label>
                            <label class="check-item opt-withdraw"><input type="checkbox" id="withdraw2" onchange="calculateAll()"><span>항소취하</span></label>
                            <label class="check-item opt-scrivener"><input type="checkbox" id="useScrivener2" onchange="calculateAll()"><span>서기료 포함</span></label>
                            <label class="check-item opt-paper"><input type="checkbox" id="isPaper2" onchange="calculateAll()"><span>종이소송</span></label>
                        </div>
                        <div class="result-section">
                            <div class="result-row" id="row-lawyer-2"><span class="lbl">변호사 보수</span><span class="val lawyer" id="lawyer2">0</span></div>
                            <div class="result-row" id="row-scrivener-2"><span class="lbl">서기료</span><span class="val scrivener inactive" id="scrivener2">0</span></div>
                            <div class="result-row" id="row-stamp-2"><span class="lbl">인지대</span><span class="val court inactive" id="stamp2">0</span></div>
                            <div class="result-row" id="row-service-2"><span class="lbl">송달료</span><span class="val court inactive" id="service2">0</span></div>
                        </div>
                    </div>
                </div>

                <div class="card card-hidden" id="card-3">
                    <div class="card-header"><span id="txt-inst-3">3심 (상고심)</span> <span class="badge">대법원</span></div>
                    <div class="fee-inputs-wrapper">
                        <div class="input-group">
                            <label style="color:#15803d">지출한 변호사 착수금</label>
                            <input type="text" id="startFee3" placeholder="금액 입력" onkeyup="formatCurrency(this, 3);">
                        </div>
                        <div class="input-group" style="margin-bottom:0">
                            <label style="color:#15803d">지출한 변호사 성공보수</label>
                            <input type="text" id="successFee3" placeholder="금액 입력" onkeyup="formatCurrency(this, 3);">
                        </div>
                    </div>
                    <div id="soga-container-3" class="soga-inputs-wrapper">
                        <div class="input-group">
                            <label>불복범위 (소가)</label>
                            <input type="text" id="soga3" placeholder="금액 입력" onkeyup="formatCurrency(this, 3);">
                            <div class="helper-text" id="korean3">0원</div>
                        </div>
                        <div class="options-container">
                            <label class="check-item opt-court"><input type="checkbox" id="isPetitioner3" onchange="calculateAll()"><span>상고인일 경우 체크</span></label>
                            <label class="check-item opt-withdraw hidden" id="opt-before-3" style="color:#b91c1c"><input type="checkbox" id="beforeInterrogation3" onchange="calculateAll()"><span>심문기일 전 취하</span></label>
                            <label class="check-item opt-withdraw"><input type="checkbox" id="withdraw3" onchange="calculateAll()"><span>상고취하</span></label>
                            <label class="check-item opt-scrivener"><input type="checkbox" id="useScrivener3" onchange="calculateAll()"><span>서기료 포함</span></label>
                            <label class="check-item opt-paper"><input type="checkbox" id="isPaper3" onchange="calculateAll()"><span>종이소송</span></label>
                        </div>
                        <div class="result-section">
                            <div class="result-row" id="row-lawyer-3"><span class="lbl">변호사 보수</span><span class="val lawyer" id="lawyer3">0</span></div>
                            <div class="result-row" id="row-scrivener-3"><span class="lbl">서기료</span><span class="val scrivener inactive" id="scrivener3">0</span></div>
                            <div class="result-row" id="row-stamp-3"><span class="lbl">인지대</span><span class="val court inactive" id="stamp3">0</span></div>
                            <div class="result-row" id="row-service-3"><span class="lbl">송달료</span><span class="val court inactive" id="service3">0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="total-section">
                <div class="total-label">총 예상 소송비용 합계</div>
                <div class="total-amount" id="grandTotal">0원</div>
                <div class="breakdown">
                    <div class="bd-item"><div class="dot" style="background:var(--color-lawyer)"></div>변호사: <strong id="totalLawyer">0</strong></div>
                    <div class="bd-item"><div class="dot" style="background:var(--color-scrivener)"></div>서기료: <strong id="totalScrivener">0</strong></div>
                    <div class="bd-item"><div class="dot" style="background:var(--color-court)"></div>법원비용: <strong id="totalCourt">0</strong></div>
                </div>
            </div>
            <button id="btnToEvidence" class="btn-start" onclick="goToEvidence()" disabled style="margin-top: 30px;">소명 자료 입력하기</button>
        </div>
    </div>

    <div id="evidencePage" class="page-section hidden">
        <div class="intro-card" style="max-width: 800px;">
            <div class="intro-title">소명 자료 선택</div>
            <div class="evidence-container">
                <div class="evidence-group">
                    <div class="evidence-group-title">공통 / 기본 서류</div>
                    <div class="evidence-list">
                        <label class="evidence-item"><input type="checkbox" value="소송비용계산서" checked disabled><span>소송비용계산서</span></label>
                        <label class="evidence-item"><input type="checkbox" value="소송위임장"><span>소송위임장</span></label>
                        <label class="evidence-item"><input type="checkbox" value="서기료 영수증"><span>서기료 영수증</span></label>
                    </div>
                </div>
                <div class="evidence-group" id="ev-group-1">
                    <div class="evidence-group-title">1심 관련</div>
                    <div class="evidence-list">
                        <label class="evidence-item"><input type="checkbox" value="1심 사건 위임 계약서"><span>1심 사건 위임 계약서</span></label>
                        <label class="evidence-item"><input type="checkbox" value="1심 변호사 착수금 이체내역"><span>1심 변호사 착수금 이체내역</span></label>
                        <label class="evidence-item"><input type="checkbox" value="1심 변호사 성공보수 이체내역"><span>1심 변호사 성공보수 이체내역</span></label>
                        <label class="evidence-item"><input type="checkbox" value="1심 판결문 정본" checked><span>1심 판결문 정본 (필수)</span></label>
                        <label class="evidence-item"><input type="checkbox" value="1심 송달 및 확정증명서"><span>1심 송달 및 확정증명서</span></label>
                    </div>
                </div>
                <div class="evidence-group hidden" id="ev-group-2">
                    <div class="evidence-group-title">2심 관련</div>
                    <div class="evidence-list">
                         <label class="evidence-item"><input type="checkbox" value="2심 사건 위임 계약서"><span>2심 사건 위임 계약서</span></label>
                         <label class="evidence-item"><input type="checkbox" value="2심 판결문 정본" checked><span>2심 판결문 정본</span></label>
                    </div>
                </div>
                 <div class="evidence-group hidden" id="ev-group-3">
                    <div class="evidence-group-title">3심 관련</div>
                    <div class="evidence-list">
                         <label class="evidence-item"><input type="checkbox" value="3심 판결문 정본" checked><span>3심 판결문 정본</span></label>
                    </div>
                </div>
            </div>
            <button class="btn-start" onclick="goToPreview()">소송비용확정신청서 및<br>소송비용계산서 미리보기</button>
        </div>
    </div>

    <div id="previewPage" class="page-section hidden">
        <div class="doc-preview">
            <div class="party-box">
                <div class="party-label">신 청 인</div>
                <div class="party-content" id="prev-appName">홍길동</div>
                <div class="party-content" id="prev-appAddr">주소...</div>
                <div id="prev-rep-box" style="margin-top:10px;">
                    <div class="party-content">신청인의 소송대리인 <span id="prev-lawFirm"></span></div>
                    <div class="agent-content">담당변호사 <span id="prev-lawyerName"></span></div>
                    <div class="agent-content" id="prev-repAddr"></div>
                </div>
            </div>
            <div class="party-box" style="margin-top:30px;">
                <div class="party-label">피 신 청 인</div>
                <div class="party-content" id="prev-respName"></div>
                <div class="party-content" id="prev-respAddr"></div>
            </div>
            <div class="doc-header-title">소송비용확정신청서</div>
            <div class="doc-section-title">신 청 취 지</div>
            <div class="doc-text">
                1. 위 당사자 사이의 <span id="prev-judgements"></span>에 따라 피신청인이 상환하여야 할 소송비용액은 금 <span id="prev-totalAmount" style="font-weight:bold">0</span>원임을 확정한다
            </div>
            <div class="doc-text">라는 결정을 구합니다.</div>
            <div class="doc-section-title">신 청 이 유</div>
            <div class="doc-text">
                위 당사자 사이의 <span id="prev-final-judgement"></span>이 <span id="prev-finalDate"></span>자로 확정되었으므로, 별지 비용 계산서 및 소명자료를 첨부하여 신청합니다.
            </div>
            <div class="doc-section-title" style="text-align: left; margin-left: 20px;">첨 부 서 류</div>
            <div class="doc-list" id="prev-evidenceList"></div>
            <div class="doc-footer-date" id="prev-date"></div>
            <div class="doc-footer-court"><span id="prev-courtName"></span> 귀중</div>
            <div class="doc-signature">
                신청인의 소송대리인<br>
                <span id="prev-signFirm"></span><br>
                <span style="display:inline-block; margin-top:5px;">담당변호사 <span id="prev-signLawyer"></span> (인)</span>
            </div>
        </div>
        <div class="page-break"></div>
        <div class="doc-preview">
            <div style="font-size: 14pt; margin-bottom: 20px;">[별지]</div>
            <div class="calc-header">소송비용계산서</div>
            <div class="calc-info-line">1. 신청인 : 원고 (상소인)</div>
            <div class="calc-info-line">2. 소가 : <span id="prev-calc-soga"></span>원 (최종심 기준)</div>
            <div class="calc-info-line">3. 신청인이 지출한 소송비용</div>
            <table class="calc-table">
                <colgroup><col style="width: 12%;"><col style="width: 18%;"><col style="width: 20%;"><col style="width: 50%;"></colgroup>
                <thead><tr><th>심급</th><th>비목</th><th>비용액</th><th>비고 (계산 근거)</th></tr></thead>
                <tbody id="calcTableBody"></tbody>
            </table>
        </div>
        <div class="preview-actions" style="margin-top:20px;">
            <button class="btn-start" onclick="window.print()" style="width:auto; padding:10px 20px;">인쇄 / PDF 저장</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // [사용자 설정] API 서버 주소
    const API_SERVER_URL = "https://your-api-server.com/analyze"; 
    // ==========================================

    window.addEventListener('DOMContentLoaded', function() {
        try {
            setTimeout(function() {
                var overlay = document.getElementById('intro-overlay');
                var container = document.getElementById('mainContainer');
                if(overlay) overlay.style.display = 'none';
                if(container) container.style.opacity = '1';
                updateBackButtonVisibility(); 
            }, 2500); 
        } catch (e) { console.error(e); }
        
        setupAutocomplete("courtName1", "suggestionList1");
        setupAutocomplete("courtName2", "suggestionList2");
        setupDragAndDrop();
    });

    // --- [NEW] 수동 작성 버튼 로직 ---
    function showManualInput() {
        const section = document.getElementById('manualInputSection');
        section.classList.remove('hidden');
        section.classList.add('fade-in-section');
        // 부드럽게 스크롤 이동
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- [NEW] 드래그 앤 드롭 설정 ---
    function setupDragAndDrop() {
        const dropZone = document.getElementById('smartUploadZone');

        // 드래그 중 효과
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            }, false);
        });

        // 드래그 떠날 때/드롭 시 효과 제거
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            }, false);
        });

        // 파일 드롭 시 처리
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }, false);
    }

    // --- API 업로드 핸들러 ---
    async function handleFiles(files) {
        if (!files || files.length === 0) return;

        if (!API_SERVER_URL || API_SERVER_URL.includes("your-api-server")) {
            alert("API 서버 주소가 설정되지 않았습니다.\nHTML 코드 상단의 'API_SERVER_URL' 변수를 수정해주세요.");
            return;
        }

        const loader = document.getElementById('upload-loader');
        loader.classList.remove('hidden');

        const formData = new FormData();
        for(let i=0; i<files.length; i++) {
            formData.append('documents', files[i]);
        }

        try {
            const response = await fetch(API_SERVER_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error(`API 오류: ${response.status}`);

            const resultData = await response.json();
            
            // 데이터 매핑 시 수동 입력창이 숨겨져 있다면 열어줌
            showManualInput();
            
            // 데이터 자동 입력
            fillFormData(resultData);
            
            alert("문서 분석이 완료되었습니다.\n자동으로 입력된 내용을 확인해주세요.");

        } catch (error) {
            console.error("Upload Error:", error);
            alert("문서 분석 중 오류가 발생했습니다.\n서버 상태를 확인하거나 수동으로 입력해주세요.");
            showManualInput(); // 오류나도 입력창은 열어줌
        } finally {
            loader.classList.add('hidden');
        }
    }

    function fillFormData(data) {
        if(data.applicantName) setAndTrigger('applicantName', data.applicantName);
        if(data.applicantAddr) setAndTrigger('applicantAddr', data.applicantAddr);
        if(data.repName) setAndTrigger('repName', data.repName);
        if(data.repLawyer) setAndTrigger('repLawyerName', data.repLawyer);
        if(data.repAddr) setAndTrigger('repAddr', data.repAddr);
        if(data.respondentName) {
            document.getElementById('step3-area').classList.remove('hidden');
            document.getElementById('btnToCaseInfo').classList.remove('hidden');
            setAndTrigger('respondentName', data.respondentName);
            setAndTrigger('respondentAddr', data.respondentAddr || "");
        }
        if(data.courtName1) setAndTrigger('courtName1', data.courtName1);
        if(data.caseNo1) setAndTrigger('caseNo1', data.caseNo1);
        if(data.date1) setAndTrigger('date1', data.date1);
        if(data.courtName2) {
             document.getElementById('case-step-2').classList.remove('hidden');
             setAndTrigger('courtName2', data.courtName2);
        }
        if(data.caseNo2) setAndTrigger('caseNo2', data.caseNo2);
        if(data.date2) setAndTrigger('date2', data.date2);
        if(data.startFee1) setAndTrigger('startFee1', data.startFee1);
        if(data.soga1) setAndTrigger('soga1', data.soga1);
    }

    function setAndTrigger(id, value) {
        const el = document.getElementById(id);
        if(el) {
            el.value = value;
            el.classList.add('ai-filled'); 
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            if (id.includes('Fee') || id.includes('soga')) {
                 el.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
            }
        }
    }

    // --- (기존 로직: 폼 제어 및 계산, 미리보기 등) ---
    const appName = document.getElementById('applicantName');
    const appAddr = document.getElementById('applicantAddr');
    const step2Area = document.getElementById('step2-area');
    const repName = document.getElementById('repName');
    const repAddr = document.getElementById('repAddr');
    const noRepCheck = document.getElementById('noRepresentative');
    const step3Area = document.getElementById('step3-area');
    const respName = document.getElementById('respondentName');
    const respAddr = document.getElementById('respondentAddr');
    const btnToCaseInfo = document.getElementById('btnToCaseInfo');

    const familyCases = {
        "가류": ["혼인 무효", "이혼 무효", "인지 무효", "친생자관계존부확인", "입양 무효", "파양 무효"],
        "나류": ["사실상혼인관계존부확인", "혼인 취소", "이혼 취소", "재판상 이혼", "부의 결정", "친생부인", "인지 취소", "인지에 대한 이의", "인지청구", "입양 취소", "파양 취소", "재판상 파양", "친양자 입양 취소", "친양자 파양"],
        "다류": ["약혼해제/사실혼파기 손해배상", "혼인/이혼 무효/취소 손해배상", "입양/파양 무효/취소 손해배상", "재산분할 관련 사해행위 취소"],
        "마류": ["재산분할", "상속재산분할"]
    };
    let currentFamilyCategory = "";

    function checkStep1() {
        if (appName.value.trim() !== "" && appAddr.value.trim() !== "") {
            if (step2Area.classList.contains('hidden')) {
                step2Area.classList.remove('hidden');
                step2Area.classList.add('fade-in-section');
            }
        }
    }
    appName.addEventListener('input', checkStep1);
    appAddr.addEventListener('input', checkStep1);

    function checkStep2() {
        const isChecked = noRepCheck.checked;
        const isFilled = (repName.value.trim() !== "" && repAddr.value.trim() !== "");
        if (isChecked || isFilled) {
            if (step3Area.classList.contains('hidden')) {
                step3Area.classList.remove('hidden');
                step3Area.classList.add('fade-in-section');
            }
        }
    }
    repName.addEventListener('input', checkStep2);
    repAddr.addEventListener('input', checkStep2);

    function toggleRepInputs(checkbox) {
        const repInputs = document.getElementById('rep-inputs');
        const repNameInput = document.getElementById('repName');
        const repAddrInput = document.getElementById('repAddr');
        const repLawyer = document.getElementById('repLawyerName');
        if (checkbox.checked) {
            repInputs.style.opacity = '0.5'; repInputs.style.pointerEvents = 'none';
            repNameInput.value = ''; repAddrInput.value = ''; if(repLawyer) repLawyer.value = '';
            checkStep2();
        } else {
            repInputs.style.opacity = '1'; repInputs.style.pointerEvents = 'auto';
        }
    }

    function checkStep3() {
        if (respName.value.trim() !== "" && respAddr.value.trim() !== "") {
            if (btnToCaseInfo.classList.contains('hidden')) {
                btnToCaseInfo.classList.remove('hidden'); btnToCaseInfo.classList.add('fade-in-section');
            }
        }
    }
    respName.addEventListener('input', checkStep3);
    respAddr.addEventListener('input', checkStep3);

    function playTransition(message, callback) {
        const overlay = document.getElementById('transition-overlay');
        const textContent = document.getElementById('transition-text-content');
        textContent.innerHTML = message;
        overlay.classList.remove('hidden');
        textContent.classList.add('animate-flow');
        setTimeout(() => {
            overlay.classList.add('hidden'); textContent.classList.remove('animate-flow');
            if (callback) callback();
        }, 2500);
    }

    function goToCaseInfo() {
        playTransition("인적 사항을 확인했어요.<br>이제 수행하신 소송의 법원명, 사건번호를 기재해주세요.", function() {
            document.getElementById('introPage').classList.add('hidden');
            const casePage = document.getElementById('caseInfoPage');
            casePage.classList.remove('hidden'); casePage.classList.add('fade-in-section');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            updateBackButtonVisibility(); 
        });
    }

    function checkCaseInfoStep() {
        const court1 = document.getElementById('courtName1').value.trim();
        const caseNo1 = document.getElementById('caseNo1').value.trim();
        const finalized1 = document.getElementById('finalized1').checked;
        const step2Div = document.getElementById('case-step-2');
        const step3Div = document.getElementById('case-step-3');
        const btnCalc = document.getElementById('btnToCalculator');
        const step1Valid = (court1 !== "" && caseNo1 !== "");

        if (step1Valid && !finalized1) {
            if (step2Div.classList.contains('hidden')) { step2Div.classList.remove('hidden'); step2Div.classList.add('fade-in-section'); }
        } else { step2Div.classList.add('hidden'); step3Div.classList.add('hidden'); }

        const court2 = document.getElementById('courtName2').value.trim();
        const caseNo2 = document.getElementById('caseNo2').value.trim();
        const finalized2 = document.getElementById('finalized2').checked;
        
        if (!step2Div.classList.contains('hidden') && court2 !== "" && caseNo2 !== "" && !finalized2) {
             if (step3Div.classList.contains('hidden')) { step3Div.classList.remove('hidden'); step3Div.classList.add('fade-in-section'); }
        } else { step3Div.classList.add('hidden'); }

        const caseNo3 = document.getElementById('caseNo3').value.trim();
        const cond1 = step1Valid && finalized1;
        const cond2 = step1Valid && !finalized1 && (court2 !== "" && caseNo2 !== "") && finalized2;
        const cond3 = step1Valid && !finalized1 && (court2 !== "" && caseNo2 !== "") && !finalized2 && (caseNo3 !== "");

        if (cond1 || cond2 || cond3) {
            if (btnCalc.classList.contains('hidden')) { btnCalc.classList.remove('hidden'); btnCalc.classList.add('fade-in-section'); }
        } else { btnCalc.classList.add('hidden'); }
    }

    function getMaxInstanceLevel() {
        if (document.getElementById('finalized1').checked) return 1;
        if (document.getElementById('finalized2').checked) return 2;
        return 3; 
    }

    function goToCalculator() {
        const appNameVal = appName.value.trim() || "입력안함";
        let repNameVal = repName.value.trim();
        if(noRepCheck.checked) repNameVal = "없음 (본인 소송)";
        else if (!repNameVal) repNameVal = "입력안함";
        const respNameVal = respName.value.trim() || "입력안함";

        document.getElementById('dispAppName').innerText = appNameVal;
        document.getElementById('dispRepName').innerText = repNameVal;
        document.getElementById('dispRespName').innerText = respNameVal;

        const maxLevel = getMaxInstanceLevel();
        let summaryHtml = "";
        const court1 = document.getElementById('courtName1').value || "-";
        const caseNo1 = document.getElementById('caseNo1').value || "-";
        summaryHtml += `<div class="case-item"><span>1심</span> <span>${court1} ${caseNo1}</span></div>`;
        if (maxLevel >= 2) {
            const court2 = document.getElementById('courtName2').value || "-";
            const caseNo2 = document.getElementById('caseNo2').value || "-";
            summaryHtml += `<div class="case-item"><span>2심</span> <span>${court2} ${caseNo2}</span></div>`;
        }
        if (maxLevel >= 3) {
            const court3 = document.getElementById('courtName3').value || "대법원";
            const caseNo3 = document.getElementById('caseNo3').value || "-";
            summaryHtml += `<div class="case-item"><span>3심</span> <span>${court3} ${caseNo3}</span></div>`;
        }
        document.getElementById('caseSummary').innerHTML = summaryHtml;
        playTransition("법원 및 사건 정보를 확인했어요.<br>이제 소송비용을 계산하도록 할게요.", function() {
            document.getElementById('caseInfoPage').classList.add('hidden');
            const calcPage = document.getElementById('calcPage');
            calcPage.classList.remove('hidden'); calcPage.classList.add('fade-in-section');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateFamilyOptions(); updateBackButtonVisibility();
        });
    }

    function populateFamilyOptions() {
        const select = document.getElementById('familySpecificCase');
        while (select.options.length > 1) { select.remove(1); }
        const categories = ["가류", "나류", "다류", "마류"];
        categories.forEach(cat => {
            const group = document.createElement('optgroup'); group.label = cat + " 사건";
            familyCases[cat].forEach(caseName => {
                const option = document.createElement('option'); option.value = caseName; option.text = caseName; group.appendChild(option);
            });
            select.appendChild(group);
        });
    }

    function handleFamilyCaseChange() {
        const selectedCase = document.getElementById('familySpecificCase').value;
        const displayDiv = document.getElementById('family-category-display');
        if (!selectedCase) { currentFamilyCategory = ""; displayDiv.innerText = ""; calculateAll(); return; }
        let foundCategory = "";
        for (const [category, cases] of Object.entries(familyCases)) {
            if (cases.includes(selectedCase)) { foundCategory = category; break; }
        }
        currentFamilyCategory = foundCategory;
        if(foundCategory) displayDiv.innerText = `선택하신 사건은 [${foundCategory}] 사건으로 분류됩니다.`;
        else displayDiv.innerText = "";
        calculateAll();
    }

    const SERVICE_UNIT_PRICE = 5500; 

    function formatCurrency(input, idSuffix) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) {
            const numVal = parseInt(value, 10);
            input.value = numVal.toLocaleString('ko-KR');
            const koreanEl = document.getElementById('korean' + idSuffix);
            if(koreanEl) koreanEl.innerText = numberToKorean(numVal) + ' 원';
        } else {
            input.value = '';
            const koreanEl = document.getElementById('korean' + idSuffix);
            if(koreanEl) koreanEl.innerText = '0원';
        }
        calculateAll();
    }

    function updateNextCardVisibility() {
        const maxLevel = getMaxInstanceLevel(); 
        const card1 = document.getElementById('card-1'); card1.classList.remove('card-hidden'); card1.style.display = 'flex';
        const start1 = document.getElementById('startFee1').value;
        const success1 = document.getElementById('successFee1').value;
        const soga1 = document.getElementById('soga1').value;
        const isCard1Filled = (start1 !== "" && success1 !== "" && soga1 !== "");
        const card2 = document.getElementById('card-2');
        let showCard2 = false;
        if (maxLevel >= 2 && isCard1Filled) showCard2 = true;
        if (showCard2) {
            if (card2.style.display !== 'flex') { card2.classList.remove('card-hidden'); card2.style.display = 'flex'; card2.classList.add('fade-in'); }
        } else { card2.style.display = 'none'; card2.classList.add('card-hidden'); }
        const start2 = document.getElementById('startFee2').value;
        const success2 = document.getElementById('successFee2').value;
        const soga2 = document.getElementById('soga2').value;
        const isCard2Filled = (start2 !== "" && success2 !== "" && soga2 !== "");
        const card3 = document.getElementById('card-3');
        let showCard3 = false;
        if (maxLevel >= 3 && showCard2 && isCard2Filled) showCard3 = true;
        if (showCard3) {
            if (card3.style.display !== 'flex') { card3.classList.remove('card-hidden'); card3.style.display = 'flex'; card3.classList.add('fade-in'); }
        } else { card3.style.display = 'none'; card3.classList.add('card-hidden'); }
    }

    function checkCalculatorCompletion() {
        const maxLevel = getMaxInstanceLevel();
        const btn = document.getElementById('btnToEvidence');
        const s1 = document.getElementById('startFee1').value; const sc1 = document.getElementById('successFee1').value; const g1 = document.getElementById('soga1').value;
        if (s1==="" || sc1==="" || g1==="") { btn.disabled = true; return; }
        if (maxLevel >= 2) {
             const card2 = document.getElementById('card-2');
             if (!card2.classList.contains('card-hidden') && card2.style.display !== 'none') {
                 const s2 = document.getElementById('startFee2').value; const sc2 = document.getElementById('successFee2').value; const g2 = document.getElementById('soga2').value;
                 if (s2==="" || sc2==="" || g2==="") { btn.disabled = true; return; }
             }
        }
        if (maxLevel >= 3) {
             const card3 = document.getElementById('card-3');
             if (!card3.classList.contains('card-hidden') && card3.style.display !== 'none') {
                 const s3 = document.getElementById('startFee3').value; const sc3 = document.getElementById('successFee3').value; const g3 = document.getElementById('soga3').value;
                 if (s3==="" || sc3==="" || g3==="") { btn.disabled = true; return; }
             }
        }
        btn.disabled = false;
    }

    function getNumberValue(id) {
        const el = document.getElementById(id);
        if(!el) return 0;
        const val = el.value.replace(/,/g, '');
        return val ? parseInt(val, 10) : 0;
    }

    function numberToKorean(number) {
        if(number == 0) return '0';
        var unitWords = ['', '만', '억', '조', '경']; var unit = 10000; var splitCount = unitWords.length; var resultArray = []; var resultString = '';
        for (var i = 0; i < splitCount; i++){ var unitResult = (number % Math.pow(unit, i + 1)) / Math.pow(unit, i); unitResult = Math.floor(unitResult); if (unitResult > 0){ resultArray[i] = unitResult; } }
        for (var i = 0; i < resultArray.length; i++){ if(!resultArray[i]) continue; resultString = String(resultArray[i]) + unitWords[i] + ' ' + resultString; }
        return resultString.trim();
    }

    function showContentAndCalculate() {
        const caseType = document.getElementById('caseType').value;
        const mainContent = document.getElementById('main-calc-content');
        const familyContainer = document.getElementById('family-specific-container');
        if (caseType === 'family') { familyContainer.classList.remove('hidden'); familyContainer.classList.add('fade-in'); } 
        else { familyContainer.classList.add('hidden'); document.getElementById('familySpecificCase').value = ""; currentFamilyCategory = ""; document.getElementById('family-category-display').innerText = ""; }
        if (caseType) { mainContent.classList.remove('hidden'); mainContent.classList.add('fade-in-section'); calculateAll(); }
    }

    function calculateAll() {
        const caseType = document.getElementById('caseType').value;
        if (!caseType) return;
        updateNextCardVisibility();
        let partyCount = parseInt(document.getElementById('partyCount').value);
        if(isNaN(partyCount) || partyCount < 2) partyCount = 2; 
        let totalLawyer = 0; let totalScrivener = 0; let totalCourt = 0;

        for (let i = 1; i <= 3; i++) {
            const cardEl = document.getElementById('card-' + i);
            if (i > 1 && (!cardEl || cardEl.classList.contains('card-hidden') || cardEl.style.display === 'none')) continue; 
            const soga = getNumberValue('soga' + i);
            const startFee = getNumberValue('startFee' + i);
            const successFee = getNumberValue('successFee' + i);
            const actualLawyerCost = startFee + successFee;
            const isWithdraw = document.getElementById('withdraw' + i).checked;
            const useScrivener = document.getElementById('useScrivener' + i).checked;
            const isPaper = document.getElementById('isPaper' + i).checked;
            let isPayer = false;
            if (i === 1) isPayer = document.getElementById('isPlaintiff1').checked;
            if (i === 2) isPayer = document.getElementById('isAppellant2').checked;
            if (i === 3) isPayer = document.getElementById('isPetitioner3').checked;

            let recognizedFee = 0;
            let limit = calcLawyerFeeLimit(soga);
            if (isWithdraw) limit = Math.floor(limit * 0.5);
            recognizedFee = Math.min(actualLawyerCost, limit);

            let sFee = 0;
            const elScrivener = document.getElementById('scrivener' + i);
            if (useScrivener) { sFee = calcScrivenerFee(soga); elScrivener.classList.remove('inactive'); } 
            else { elScrivener.classList.add('inactive'); }

            let stamp = 0; let service = 0;
            const elStamp = document.getElementById('stamp' + i);
            const elService = document.getElementById('service' + i);
            if (isPayer) {
                stamp = calcStampDuty(soga, i, caseType, isPaper);
                service = calcServiceFee(i, partyCount, caseType, soga);
                elStamp.classList.remove('inactive'); elService.classList.remove('inactive');
            } else { elStamp.classList.add('inactive'); elService.classList.add('inactive'); }

            document.getElementById('lawyer' + i).innerText = recognizedFee.toLocaleString();
            document.getElementById('scrivener' + i).innerText = sFee.toLocaleString();
            document.getElementById('stamp' + i).innerText = stamp.toLocaleString();
            document.getElementById('service' + i).innerText = service.toLocaleString();
            totalLawyer += recognizedFee; totalScrivener += sFee; totalCourt += (stamp + service);
        }
        const grandTotal = totalLawyer + totalScrivener + totalCourt;
        document.getElementById('grandTotal').innerText = grandTotal.toLocaleString() + " 원";
        document.getElementById('totalLawyer').innerText = totalLawyer.toLocaleString();
        document.getElementById('totalScrivener').innerText = totalScrivener.toLocaleString();
        document.getElementById('totalCourt').innerText = totalCourt.toLocaleString();
        checkCalculatorCompletion();
    }

    function calcLawyerFeeLimit(soga) {
        if (soga <= 0) return 0;
        if (soga <= 3000000) return 300000;
        else if (soga <= 20000000) return Math.floor(soga * 0.1); 
        else if (soga <= 50000000) return 2000000 + Math.floor((soga - 20000000) * 0.08);
        else if (soga <= 100000000) return 4400000 + Math.floor((soga - 50000000) * 0.06);
        else if (soga <= 150000000) return 7400000 + Math.floor((soga - 100000000) * 0.04);
        else if (soga <= 200000000) return 9400000 + Math.floor((soga - 150000000) * 0.02);
        else if (soga <= 500000000) return 10400000 + Math.floor((soga - 200000000) * 0.01);
        else return 13400000 + Math.floor((soga - 500000000) * 0.005);
    }

    function calcScrivenerFee(soga) {
        if (soga <= 0) return 0;
        if (soga <= 30000000) return 560000;
        else if (soga <= 200000000) return 560000 + Math.floor((soga - 30000000) * 0.0010);
        else if (soga <= 500000000) return 730000 + Math.floor((soga - 200000000) * 0.0009);
        else if (soga <= 1000000000) return 1000000 + Math.floor((soga - 500000000) * 0.0004);
        else if (soga <= 2000000000) return 1200000 + Math.floor((soga - 1000000000) * 0.0003);
        else return 1500000 + Math.floor((soga - 2000000000) * 0.0001);
    }

    function calcStampDuty(soga, instance, caseType, isPaper) {
        if(soga === 0) return 0;
        if (caseType === 'patent') soga = 100000000;
        if (caseType === 'family' && currentFamilyCategory === '마류') soga = Math.floor(soga / 3);
        let baseStamp = 0;
        if (caseType === 'family' && (currentFamilyCategory === '가류' || currentFamilyCategory === '나류')) baseStamp = 18000;
        else if (caseType === 'civil_app') { const mainStamp = calcCivilBaseStamp(soga); baseStamp = Math.floor(mainStamp * 0.5); if (baseStamp > 450000) baseStamp = 450000; }
        else baseStamp = calcCivilBaseStamp(soga);
        let multiplier = 1.0; if (instance === 2) multiplier = 1.5; if (instance === 3) multiplier = 2.0;
        let finalStamp = baseStamp * multiplier;
        if (!isPaper) finalStamp = finalStamp * 0.9;
        finalStamp = Math.floor(finalStamp / 100) * 100;
        const minStamp = isPaper ? 1000 : 900; if (finalStamp < minStamp) finalStamp = minStamp;
        return finalStamp;
    }

    function calcCivilBaseStamp(soga) {
        if (soga < 10000000) return soga * 0.0050; else if (soga < 100000000) return soga * 0.0045 + 5000; else if (soga < 1000000000) return soga * 0.0040 + 55000; else return soga * 0.0035 + 555000;
    }

    function calcServiceFee(instance, totalParties, caseType, soga) {
        const UNIT = 5500; let targetCount = Math.max(1, totalParties - 1); let times = 0;
        if (caseType === 'civil') { if (instance === 1) { if (soga < 30000000) times = 10; else times = 15; } else if (instance === 2) times = 12; else times = 8; } 
        else if (caseType === 'civil_app') { targetCount = totalParties; times = 2; }
        else if (caseType === 'family') { if (instance === 1) times = 15; else if (instance === 2) times = 12; else times = 8; }
        else if (caseType === 'admin') { if (instance === 1) times = 10; else if (instance === 2) times = 10; else times = 8; }
        else if (caseType === 'patent') { if (instance === 1) times = 10; else times = 8; }
        return targetCount * times * UNIT;
    }

    function goToEvidence() {
        playTransition("이제 거의 다 왔습니다.<br>지출한 소송 비용을 소명할 수 있는 자료를 선택해주세요.", function() {
            document.getElementById('calcPage').classList.add('hidden');
            const maxLevel = getMaxInstanceLevel();
            if (maxLevel >= 2) document.getElementById('ev-group-2').classList.remove('hidden'); else document.getElementById('ev-group-2').classList.add('hidden');
            if (maxLevel >= 3) document.getElementById('ev-group-3').classList.remove('hidden'); else document.getElementById('ev-group-3').classList.add('hidden');
            const evPage = document.getElementById('evidencePage'); evPage.classList.remove('hidden'); evPage.classList.add('fade-in-section');
            window.scrollTo({ top: 0, behavior: 'smooth' }); updateBackButtonVisibility();
        });
    }

    function goToPreview() {
        playTransition("입력해주신 내용을 토대로<br>PDF 양식에 맞춘 신청서를 작성합니다.", function() {
            document.getElementById('evidencePage').classList.add('hidden');
            renderPreview();
            const pvPage = document.getElementById('previewPage'); pvPage.classList.remove('hidden'); pvPage.classList.add('fade-in-section');
            window.scrollTo({ top: 0, behavior: 'smooth' }); updateBackButtonVisibility();
        });
    }

    function renderPreview() {
        const appNameVal = document.getElementById('applicantName').value || "";
        const appAddrVal = document.getElementById('applicantAddr').value || "";
        const respNameVal = document.getElementById('respondentName').value || "";
        const respAddrVal = document.getElementById('respondentAddr').value || "";
        const repNameVal = document.getElementById('repName').value || "";
        const repLawyerVal = document.getElementById('repLawyerName') ? document.getElementById('repLawyerName').value : "";
        const repAddrVal = document.getElementById('repAddr').value || "";
        const noRep = document.getElementById('noRepresentative').checked;

        document.getElementById('prev-appName').innerText = appNameVal;
        document.getElementById('prev-appAddr').innerText = appAddrVal;
        document.getElementById('prev-respName').innerText = respNameVal;
        document.getElementById('prev-respAddr').innerText = respAddrVal;

        if (noRep || !repNameVal) {
            document.getElementById('prev-rep-box').style.display = 'none';
            document.getElementById('prev-signFirm').innerText = appNameVal;
            document.getElementById('prev-signLawyer').parentNode.style.display = 'none';
        } else {
            document.getElementById('prev-rep-box').style.display = 'block';
            document.getElementById('prev-lawFirm').innerText = repNameVal;
            document.getElementById('prev-lawyerName').innerText = repLawyerVal || "(담당변호사)";
            document.getElementById('prev-repAddr').innerText = repAddrVal;
            document.getElementById('prev-signFirm').innerText = repNameVal;
            document.getElementById('prev-signLawyer').innerText = repLawyerVal.split(',')[0] || "OOO";
            document.getElementById('prev-signLawyer').parentNode.style.display = 'inline-block';
        }

        const court1 = document.getElementById('courtName1').value;
        const case1 = document.getElementById('caseNo1').value;
        const date1 = (document.getElementById('date1') && document.getElementById('date1').value) ? document.getElementById('date1').value : "20XX. X. X.";
        let judgementText = `${court1} ${date1} 선고 ${case1} 사건 판결`;
        let finalJudgementText = judgementText; 

        const card2 = document.getElementById('card-2');
        if (card2 && card2.style.display !== 'none' && !card2.classList.contains('card-hidden')) {
            const court2 = document.getElementById('courtName2').value;
            const case2 = document.getElementById('caseNo2').value;
            const date2 = (document.getElementById('date2') && document.getElementById('date2').value) ? document.getElementById('date2').value : "20XX. X. X.";
            if (court2 && case2) { judgementText += `, ${court2} ${date2} 선고 ${case2} 사건 판결`; finalJudgementText = `${court2} ${date2} 선고 ${case2} 사건 판결`; }
        }
        const card3 = document.getElementById('card-3');
        if (card3 && card3.style.display !== 'none' && !card3.classList.contains('card-hidden')) {
            const court3 = document.getElementById('courtName3').value;
            const case3 = document.getElementById('caseNo3').value;
            const date3 = (document.getElementById('date3') && document.getElementById('date3').value) ? document.getElementById('date3').value : "20XX. X. X.";
            if (case3) { judgementText += `, ${court3} ${date3} 선고 ${case3} 사건 판결`; finalJudgementText = `${court3} ${date3} 선고 ${case3} 사건 판결`; }
        }
        document.getElementById('prev-judgements').innerText = judgementText;
        document.getElementById('prev-final-judgement').innerText = finalJudgementText;

        const fDate = (document.getElementById('finalDate') && document.getElementById('finalDate').value) ? document.getElementById('finalDate').value : "20XX. X. X.";
        document.getElementById('prev-finalDate').innerText = fDate;

        const today = new Date();
        document.getElementById('prev-date').innerText = `${today.getFullYear()}. ${today.getMonth()+1}.`;
        document.getElementById('prev-courtName').innerText = (court1 || "OO지방법원");

        const maxLevel = getMaxInstanceLevel();
        const checkboxes = document.querySelectorAll('.evidence-item input[type="checkbox"]:checked');
        let evHtml = '<ol>';
        checkboxes.forEach(cb => { 
            const parentGroup = cb.closest('.evidence-group');
            let include = true;
            if (parentGroup) {
                if (parentGroup.id === 'ev-group-2' && maxLevel < 2) include = false;
                if (parentGroup.id === 'ev-group-3' && maxLevel < 3) include = false;
            }
            if(include) evHtml += `<li>${cb.value}</li>`; 
        });
        evHtml += '</ol>';
        document.getElementById('prev-evidenceList').innerHTML = evHtml;

        const tbody = document.getElementById('calcTableBody'); tbody.innerHTML = ""; 
        let maxSoga = 0; for(let i=1; i<=3; i++) { const s = getNumberValue('soga'+i); if (s > maxSoga) maxSoga = s; }
        document.getElementById('prev-calc-soga').innerText = maxSoga.toLocaleString();

        function addRow(inst, item, amount, remarks) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="center">${inst}</td><td class="center">${item}</td><td class="right">${amount.toLocaleString()}</td><td class="left remarks">${remarks}</td>`;
            tbody.appendChild(tr);
        }
        function getLawyerFormulaText(soga, amount) {
            if (soga <= 3000000) return "300,000원 (최소한도)";
            if (soga <= 20000000) return `{${soga.toLocaleString()} × 10%}`;
            if (soga <= 50000000) return `{2,000,000원 + (${soga.toLocaleString()} - 2천만) × 8%}`;
            if (soga <= 100000000) return `{4,400,000원 + (${soga.toLocaleString()} - 5천만) × 6%}`;
            return "변호사보수의 소송비용 산입에 관한 규칙에 따름";
        }
        let tableTotalAmount = 0; 
        for(let i=1; i<=3; i++) {
            const card = document.getElementById('card-'+i);
            if (i > 1 && (card.style.display === 'none' || card.classList.contains('card-hidden'))) continue;
            const instName = (i===1) ? "1심" : (i===2 ? "2심" : "3심");
            const soga = getNumberValue('soga'+i);
            const isPaper = document.getElementById('isPaper'+i).checked;
            const scriEl = document.getElementById('scrivener'+i);
            const scriVal = scriEl ? parseInt(scriEl.innerText.replace(/,/g,'')) : 0;
            if(scriVal > 0) { addRow(instName, "서기료", scriVal, "법무사보수표에 따름"); tableTotalAmount += scriVal; }
            const lawEl = document.getElementById('lawyer'+i);
            const lawVal = lawEl ? parseInt(lawEl.innerText.replace(/,/g,'')) : 0;
            if(lawVal > 0) { const formula = getLawyerFormulaText(soga, lawVal); addRow(instName, "변호사보수", lawVal, `변호사보수 규칙 제3조,\n최대 보수: ${formula}`); tableTotalAmount += lawVal; }
            const stampEl = document.getElementById('stamp'+i);
            const stampVal = stampEl ? parseInt(stampEl.innerText.replace(/,/g,'')||0) : 0;
            if(!stampEl.classList.contains('inactive') && stampVal > 0) { const discountText = isPaper ? "종이소송(할인없음)" : "전자소송 10% 할인"; addRow(instName, "인지대", stampVal, discountText); tableTotalAmount += stampVal; }
            const servEl = document.getElementById('service'+i);
            const servVal = servEl ? parseInt(servEl.innerText.replace(/,/g,'')||0) : 0;
            if(!servEl.classList.contains('inactive') && servVal > 0) { addRow(instName, "송달료", servVal, `당사자수 및 심급별 횟수 기준\n(1회: ${SERVICE_UNIT_PRICE.toLocaleString()}원)`); tableTotalAmount += servVal; }
        }
        const fixedStamp = 900; const fixedService = 31200; 
        addRow("기타(신청)", "인지대", fixedStamp, "확정신청서 접수 인지대"); tableTotalAmount += fixedStamp;
        addRow("기타(신청)", "송달료", fixedService, "확정신청서 송달 비용"); tableTotalAmount += fixedService;
        const trTotal = document.createElement('tr');
        trTotal.innerHTML = `<td class="center" style="font-weight:bold; background:#f9f9f9;">합계</td><td class="center" style="font-weight:bold; background:#f9f9f9;"></td><td class="right" style="font-weight:bold; background:#f9f9f9;">${tableTotalAmount.toLocaleString()}</td><td class="left" style="background:#f9f9f9;"></td>`;
        tbody.appendChild(trTotal);
        document.getElementById('prev-totalAmount').innerText = tableTotalAmount.toLocaleString();
    }

    const pageOrder = ['introPage', 'caseInfoPage', 'calcPage', 'evidencePage', 'previewPage'];
    function updateBackButtonVisibility() {
        const backBtn = document.getElementById('globalBackBtn');
        const introPage = document.getElementById('introPage');
        if (!introPage.classList.contains('hidden')) backBtn.classList.remove('visible'); else backBtn.classList.add('visible');
    }
    function goBackStep() {
        let currentIndex = -1;
        for (let i = 0; i < pageOrder.length; i++) { if (!document.getElementById(pageOrder[i]).classList.contains('hidden')) { currentIndex = i; break; } }
        if (currentIndex > 0) {
            const currentPage = document.getElementById(pageOrder[currentIndex]);
            const prevPage = document.getElementById(pageOrder[currentIndex - 1]);
            currentPage.classList.add('hidden'); currentPage.classList.remove('fade-in-section'); 
            prevPage.classList.remove('hidden'); prevPage.classList.add('fade-in-section'); 
            window.scrollTo({ top: 0, behavior: 'smooth' }); updateBackButtonVisibility();
        }
    }

    const courtList = ["서울고등법원", "서울중앙지방법원", "서울남부지방법원", "서울동부지방법원", "서울북부지방법원", "서울서부지방법원", "서울가정법원", "서울행정법원", "서울회생법원", "인천지방법원", "인천지방법원 강화군법원", "인천지방법원 부천지원", "인천지방법원 부천지원 김포시법원", "인천가정법원", "수원고등법원", "수원지방법원", "수원지방법원 성남지원", "수원지방법원 성남지원 광주시법원", "수원지방법원 안산지원", "수원지방법원 안산지원 광명시법원", "수원지방법원 안양지원", "수원지방법원 여주지원", "수원지방법원 여주지원 양평군법원", "수원지방법원 여주지원 이천시법원", "수원지방법원 오산시법원", "수원지방법원 용인시법원", "수원지방법원 평택지원", "수원지방법원 평택지원 안성시법원", "의정부지방법원", "의정부지방법원 고양지원", "의정부지방법원 고양지원 파주시법원", "의정부지방법원 남양주지원", "의정부지방법원 남양주지원 가평군법원", "의정부지방법원 동두천시법원", "의정부지방법원 연천군법원", "의정부지방법원 철원군법원", "의정부지방법원 포천시법원", "춘천지방법원", "춘천지방법원 강릉지원", "춘천지방법원 강릉지원 동해시법원", "춘천지방법원 강릉지원 삼척시법원", "춘천지방법원 속초지원", "춘천지방법원 속초지원 고성군법원", "춘천지방법원 속초지원 양양군법원", "춘천지방법원 양구군법원", "춘천지방법원 영월지원", "춘천지방법원 영월지원 정선군법원", "춘천지방법원 영월지원 태백시법원", "춘천지방법원 영월지원 평창군법원", "춘천지방법원 원주지원", "춘천지방법원 원주지원 횡성군법원", "춘천지방법원 인제군법원", "춘천지방법원 홍천군법원", "춘천지방법원 화천군법원", "청주지방법원", "청주지방법원 괴산군법원", "청주지방법원 보은군법원", "청주지방법원 영동지원", "청주지방법원 영동지원 옥천군법원", "청주지방법원 제천지원", "청주지방법원 제천지원 단양군법원", "청주지방법원 진천군법원", "청주지방법원 충주지원", "청주지방법원 충주지원 음성군법원", "대전고등법원", "대전지방법원", "대전지방법원 공주지원", "대전지방법원 공주지원 청양군법원", "대전지방법원 금산군법원", "대전지방법원 논산지원", "대전지방법원 논산지원 부여군법원", "대전지방법원 서산지원", "대전지방법원 서산지원 당진시법원", "대전지방법원 서산지원 태안군법원", "대전지방법원 세종특별자치시법원", "대전지방법원 천안지원", "대전지방법원 천안지원 아산시법원", "대전지방법원 홍성지원", "대전지방법원 홍성지원 보령시법원", "대전지방법원 홍성지원 서천군법원", "대전지방법원 홍성지원 예산군법원", "대전가정법원", "대전가정법원 공주지원", "대전가정법원 논산지원", "대전가정법원 서산지원", "대전가정법원 천안지원", "대전가정법원 홍성지원", "특허법원", "대구고등법원", "대구지방법원", "대구지방법원 경산시법원", "대구지방법원 경주지원", "대구지방법원 서부지원 고령군법원", "대구지방법원 김천지원", "대구지방법원 김천지원 구미시법원", "대구지방법원 상주지원", "대구지방법원 상주지원 문경시법원", "대구지방법원 상주지원 예천군법원", "대구지방법원 서부지원", "대구지방법원 서부지원 성주군법원", "대구지방법원 안동지원", "대구지방법원 안동지원 봉화군법원", "대구지방법원 안동지원 영주시법원", "대구지방법원 영덕지원", "대구지방법원 영덕지원 영양군법원", "대구지방법원 영덕지원 울진군법원", "대구지방법원 영천시법원", "대구지방법원 의성지원", "대구지방법원 의성지원 군위군법원", "대구지방법원 의성지원 청송군법원", "대구지방법원 청도군법원", "대구지방법원 포항지원", "대구지방법원 칠곡군법원", "대구가정법원", "대구가정법원 경주지원", "대구가정법원 김천지원", "대구가정법원 상주지원", "대구가정법원 안동지원", "대구가정법원 영덕지원", "대구가정법원 의성지원", "대구가정법원 포항지원", "부산고등법원", "부산지방법원", "부산지방법원 동부지원", "부산지방법원 서부지원", "부산가정법원", "울산지방법원", "울산지방법원 양산시법원", "창원지방법원", "창원지방법원 거창지원", "창원지방법원 거창지원 함양군법원", "창원지방법원 거창지원 합천군법원", "창원지방법원 김해시법원", "창원지방법원 마산지원", "창원지방법원 마산지원 의령군법원", "창원지방법원 마산지원 함안군법원", "창원지방법원 밀양지원", "창원지방법원 밀양지원 창녕군법원", "창원지방법원 진주지원", "창원지방법원 진주지원 남해군법원", "창원지방법원 진주지원 사천시법원", "창원지방법원 진주지원 산청군법원", "창원지방법원 진주지원 하동군법원", "창원지방법원 창원남부시법원", "창원지방법원 통영지원", "창원지방법원 통영지원 거제시법원", "창원지방법원 통영지원 고성군법원", "광주고등법원", "광주지방법원", "광주지방법원 목포지원", "광주지방법원 장흥지원", "광주지방법원 순천지원", "광주지방법원 해남지원", "광주가정법원", "광주가정법원 장흥지원", "광주가정법원 순천지원", "광주가정법원 해남지원", "광주가정법원 목포지원", "광주지방법원 곡성군법원", "광주지방법원 영광군법원", "광주지방법원 나주시법원", "광주지방법원 장성군법원", "광주지방법원 화순군법원", "광주지방법원 담양군법원", "광주지방법원 목포지원 함평군법원", "광주지방법원 목포지원 영암군법원", "광주지방법원 목포지원 무안군법원", "광주지방법원 장흥지원 강진군법원", "광주지방법원 순천지원 보성군법원", "광주지방법원 순천지원 고흥군법원", "광주지방법원 순천지원 여수시법원", "광주지방법원 순천지원 구례군법원", "광주지방법원 순천지원 광양시법원", "광주지방법원 해남지원 완도군법원", "광주지방법원 해남지원 진도군법원", "전주지방법원", "전주지방법원 군산지원", "전주지방법원 군산지원 익산시법원", "전주지방법원 김제시법원", "전주지방법원 남원지원", "전주지방법원 남원지원 순창군법원", "전주지방법원 남원지원 장수군법원", "전주지방법원 무주군법원", "전주지방법원 임실군법원", "전주지방법원 정읍지원", "전주지방법원 정읍지원 고창군법원", "전주지방법원 정읍지원 부안군법원", "전주지방법원 진안군법원", "제주지방법원", "제주지방법원 서귀포시법원"];

    function setupAutocomplete(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        if (!input || !list) return;
        input.addEventListener("input", function() {
            const val = this.value; closeList(); if (!val) return;
            const matches = courtList.filter(court => court.includes(val));
            if (matches.length === 0) return;
            matches.forEach(match => {
                const item = document.createElement("li"); item.className = "suggestion-item";
                const regex = new RegExp(`(${val})`, "gi"); item.innerHTML = match.replace(regex, "<strong>$1</strong>");
                item.addEventListener("click", function() { input.value = match; closeList(); checkCaseInfoStep(); });
                list.appendChild(item);
            });
            input.classList.add("input-with-list"); list.style.display = "block";
        });
        function closeList() { list.innerHTML = ""; list.style.display = "none"; input.classList.remove("input-with-list"); }
        document.addEventListener("click", function(e) { if (e.target !== input && e.target !== list) { closeList(); } });
    }
</script>

</body>
</html>